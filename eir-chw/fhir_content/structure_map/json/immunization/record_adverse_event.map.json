{
  "resourceType": "StructureMap",
  "id": "f1a25251-d70f-4c6d-a517-98acdeda6a21",
  "text": {
    "status": "additional",
    "div": "<div xmlns=\"http://www.w3.org/1999/xhtml\"><pre>map &quot;https://fhir.demo.smartregister.org/fhir/StructureMap/f1a25251-d70f-4c6d-a517-98acdeda6a21&quot; = 'RecordAdverseEvent'\n\nuses &quot;http://hl7.org/fhir/StructureDefinition/QuestionnaireResponse&quot; as source\nuses &quot;http://hl7.org/fhir/StructureDefinition/Bundle&quot; as target\n\ngroup Aefi(source src : QuestionnaireResponse, target bundle: Bundle) {\n    src -&gt; bundle.entry as entry, entry.resource = create(&quot;Encounter&quot;) as encounter then {\n\t\tsrc -&gt; bundle.entry as entry, entry.resource = create(&quot;Condition&quot;) as condition\n            then ExtractEncounter(src, encounter),\n                 ExtractReactionManifestationCondition(src, condition, bundle),\n                 ExtractAdverseEvent(src, encounter, condition, bundle),\n                UpdatePatient(src, bundle) &quot;r_extract_resources&quot;;\n\t} &quot;r_extract_encounter&quot;;\n}\n\ngroup UpdatePatient(source src: QuestionnaireResponse, target bundle: Bundle){\n\n    src.item as dod where(linkId = '670552cf-cd9e-4596-9d89-5d6e4872d523' and answer.value.exists()) then {\n        src.item as pidItem where(linkId = 'patient-id' and answer.value.exists()) then {\n            src -&gt; bundle.entry as entry, entry.resource = create('Patient') as patient then {\n                src -&gt; patient.id = create('id') as pid then {\n                    src -&gt; pid.value = evaluate(pidItem, $this.answer.value.trim()) &quot;r_pid_value&quot;;\n                } &quot;r_patient_id&quot;;\n\n                src -&gt; evaluate(src, $this.item.where(linkId=&quot;670552cf-cd9e-4596-9d89-5d6e4872d523&quot;).answer.value) as dateOfDeath then {\n                    src -&gt; patient.deceased = create('dateTime') as dt,\n                        dt.value = evaluate(dateOfDeath, $this.value.substring(0, 10) + 'T00:00:00.00Z') &quot;r_deceased_dt&quot;;\n                } &quot;r_dod&quot;;\n\n                src -&gt; patient.active = false &quot;r_patient_active&quot;;\n\n            } &quot;r_patient&quot;;\n        } &quot;r_patient&quot;;\n    } &quot;r_dod_exists&quot;;\n}\n\ngroup ExtractEncounter(source src: QuestionnaireResponse, target encounter: Encounter){\n    src -&gt; encounter.id = uuid(),\n        encounter.status = &quot;finished&quot;,\n        encounter.class = c(&quot;http://terminology.hl7.org/CodeSystem/v3-ActCode&quot;, &quot;HH&quot;, &quot;Home health&quot;) &quot;r_en_static&quot;;\n\n    src -&gt; encounter.type = create('CodeableConcept') as cc then {\n        src -&gt; cc.text = &quot;Allergies and adverse reactions&quot; &quot;r_cc_display&quot;;\n        src -&gt; cc.coding = create('Coding') as c then {\n            src -&gt; c.system = &quot;http://smartregister.org&quot; &quot;r_c_system&quot;;\n            src -&gt; c.code = &quot;886921000000105&quot; &quot;r_c_code&quot;;\n            src -&gt; c.display = &quot;Allergies and adverse reactions&quot; &quot;r_c_display&quot;;\n        } &quot;r_c&quot;;\n    } &quot;r_cc&quot;;\n\n    src -&gt; encounter.priority = create('CodeableConcept') as cc then {\n        src -&gt; cc.text = &quot;Elective&quot; &quot;r_cc_display&quot;;\n        src -&gt; cc.coding = create('Coding') as c then {\n            src -&gt; c.system = &quot;http://terminology.hl7.org/ValueSet/v3-ActPriority&quot; &quot;r_c_system&quot;;\n            src -&gt; c.code = &quot;EL&quot; &quot;r_c_code&quot;;\n            src -&gt; c.display = &quot;Elective&quot; &quot;r_c_display&quot;;\n        } &quot;r_c&quot;;\n    } &quot;r_cc&quot;;\n\n    src.subject as subject -&gt; encounter.subject = subject &quot;r_en_subject&quot;;\n    src -&gt; encounter.participant = create(&quot;Encounter_Participant&quot;) as encounterParticipant then {\n        src -&gt; encounterParticipant.individual = create(&quot;Reference&quot;) as encOwner then {\n            src -&gt; encOwner.reference = evaluate(src, &quot;Practitioner/&quot; + $this.meta.tag.where($this.system = &quot;https://smartregister.org/practitioner-tag-id&quot;).code) &quot;r_enc_part_reference&quot;;\n        } &quot;r_enc_part_individual&quot;;\n    } &quot;r_enc_part_component&quot;;\n    src -&gt; encounter.period = create('Period') as encounterPeriod then {\n        src -&gt; encounterPeriod.start = evaluate(src, now()) &quot;r_en_period_start&quot;;\n        src -&gt; encounterPeriod.end = evaluate(src, now()) &quot;r_en_period_end&quot;;\n    } &quot;r_en_period&quot;;\n}\n\ngroup ExtractReactionManifestationCondition(source src: QuestionnaireResponse, target cnd: Condition, target bundle: Bundle) {\n    src -&gt; cnd.id = uuid() &quot;r_cnd_id&quot;;\n\n    src.item as startReactionDate where(linkId = &quot;recorded-date&quot;) then {\n      src -&gt; cnd.onset = create('dateTime') as dt, dt.value = evaluate(startReactionDate, $this.answer.value.toString()) &quot;r_cnd_onset_date_val&quot;;\n    } &quot;r_cnd_onset_date&quot;;\n\n    src -&gt; cnd.clinicalStatus = cc(&quot;http://terminology.hl7.org/CodeSystem/condition-clinical&quot;, &quot;active&quot;) &quot;r_cnd_clinical_st&quot;;\n    src.subject as subject -&gt; cnd.subject = subject &quot;r_cnd_sub&quot;;\n    src -&gt; cnd.recordedDate = evaluate(src, now()) &quot;r_cnd_recorded&quot;;\n\n    src.item as reactionManifestation where(linkId = &quot;a2f71c64-5ccc-4575-8638-d51aeefe6e6c&quot;) then {\n        src -&gt; cnd.code = create(&quot;CodeableConcept&quot;) as cc then {\n            src -&gt; cc.coding = create('Coding') as c then {\n                src -&gt; c.system = &quot;http://smartregister.org&quot; &quot;r_c_system&quot;;\n                src -&gt; c.code = evaluate(reactionManifestation, $this.answer.value.code) &quot;r_c_code&quot;;\n                src -&gt; c.display = evaluate(reactionManifestation, $this.answer.value.display) &quot;r_c_display&quot;;\n            } &quot;r_c&quot;;\n            src -&gt; cc.text = evaluate(reactionManifestation, $this.answer.value.display) &quot;r_cnd_code_text&quot;;\n        } &quot;r_cnd_code&quot;;\n    } &quot;r_reaction_manifestation&quot;;\n}\n\ngroup ExtractAdverseEvent(source src: QuestionnaireResponse, source encounter: Encounter, source condition: Condition, target bundle: Bundle){\n    src -&gt; bundle.entry as entry, entry.resource = create(&quot;AdverseEvent&quot;) as adverseEvent then {\n        src -&gt; adverseEvent.id = uuid(),\n               adverseEvent.encounter = reference(encounter),\n               adverseEvent.resultingCondition = reference(condition) &quot;r_ae_static&quot;;\n        src -&gt; evaluate(src, $this.item.where(linkId=&quot;recorded-date&quot;).answer.value) as recordedDate then {\n            src -&gt; adverseEvent.recordedDate = create('dateTime') as date,\n                   date.value = evaluate(recordedDate, $this.value.substring(0, 10) + 'T00:00:00.00Z') &quot;r_recorded_date&quot;;\n        } &quot;r_ae_recorded_date&quot;;\n\n        // suspectEntity\n        src.item as item where($this.linkId.where(contains('child-vaccines')).exists()) then {\n            src -&gt; adverseEvent.suspectEntity = create(&quot;AdverseEvent_SuspectEntity&quot;) as aeSuspectEntity then {\n                src -&gt; aeSuspectEntity.instance = create(&quot;Reference&quot;) as aeOwner then {\n                    src -&gt; evaluate(src, $this.item.where(linkId = 'child-vaccines').answer.value.reference) as immunization then {\n                        src -&gt; aeOwner.reference = immunization &quot;r_ae_suspect_entity_instance_ref_child&quot;;\n                    } &quot;r_ae_suspect_entity_instance_child&quot;;\n                } &quot;r_ae_suspect_entity_child&quot;;\n\n                src.item as reactionOutcomeItem where(linkId = &quot;9bbf6a69-3c16-4052-82a5-8ca9f9102ef3&quot; and answer.value.exists()) then {\n                    src -&gt; aeSuspectEntity.causality = create('AdverseEvent_SuspectEntityCausality') as causality then {\n                        src -&gt; causality.assessment = create('CodeableConcept') as cc then {\n                            src -&gt; cc.text = evaluate(reactionOutcomeItem, $this.answer.value.display) &quot;r_cc_display&quot;;\n                            src -&gt; cc.coding = create('Coding') as c then {\n                                src -&gt; c.system = &quot;http://smartregister.org&quot; &quot;r_c_system&quot;;\n                                src -&gt; c.code = evaluate(reactionOutcomeItem, $this.answer.value.code) &quot;r_c_code&quot;;\n                                src -&gt; c.display = evaluate(reactionOutcomeItem, $this.answer.value.display) &quot;r_c_display&quot;;\n                            } &quot;r_c&quot;;\n                        } &quot;r_cc&quot;;\n                    } &quot;r_causality&quot;;\n                } &quot;r_ro&quot;;\n\n            } &quot;r_ae_suspect_entity_child&quot;;\n        } &quot;r_ae_se_child&quot;;\n\n        src.subject as subject -&gt; adverseEvent.subject = subject &quot;r_ae_subject&quot;;\n\n        src.item as item where(linkId = &quot;287f1e51-937b-4a44-ab72-6b82a0a1475f&quot; and answer.value.exists()) then {\n            src -&gt; adverseEvent.severity = create('CodeableConcept') as cc then {\n                src -&gt; cc.text = evaluate(item, $this.answer.value.display) &quot;r_cc_display&quot;;\n                src -&gt; cc.coding = create('Coding') as c then {\n                    src -&gt; c.system = &quot;http://smartregister.org&quot; &quot;r_c_system&quot;;\n                    src -&gt; c.code = evaluate(item, $this.answer.value.code) &quot;r_c_code&quot;;\n                    src -&gt; c.display = evaluate(item, $this.answer.value.display) &quot;r_c_display&quot;;\n                } &quot;r_c&quot;;\n            } &quot;r_cc&quot;;\n        } &quot;r_tor&quot;;\n\n    } &quot;r_extract_adverse_event&quot;;\n}\n</pre></div>"
  },
  "url": "https://fhir.demo.smartregister.org/fhir/StructureMap/f1a25251-d70f-4c6d-a517-98acdeda6a21",
  "name": "RecordAdverseEvent",
  "structure": [
    {
      "url": "http://hl7.org/fhir/StructureDefinition/QuestionnaireResponse",
      "mode": "source"
    },
    {
      "url": "http://hl7.org/fhir/StructureDefinition/Bundle",
      "mode": "target"
    }
  ],
  "group": [
    {
      "name": "Aefi",
      "typeMode": "none",
      "input": [
        {
          "name": "src",
          "type": "QuestionnaireResponse",
          "mode": "source"
        },
        {
          "name": "bundle",
          "type": "Bundle",
          "mode": "target"
        }
      ],
      "rule": [
        {
          "name": "r_extract_encounter",
          "source": [
            {
              "context": "src"
            }
          ],
          "target": [
            {
              "context": "bundle",
              "contextType": "variable",
              "element": "entry",
              "variable": "entry"
            },
            {
              "context": "entry",
              "contextType": "variable",
              "element": "resource",
              "variable": "encounter",
              "transform": "create",
              "parameter": [
                {
                  "valueString": "Encounter"
                }
              ]
            }
          ],
          "rule": [
            {
              "name": "r_extract_resources",
              "source": [
                {
                  "context": "src"
                }
              ],
              "target": [
                {
                  "context": "bundle",
                  "contextType": "variable",
                  "element": "entry",
                  "variable": "entry"
                },
                {
                  "context": "entry",
                  "contextType": "variable",
                  "element": "resource",
                  "variable": "condition",
                  "transform": "create",
                  "parameter": [
                    {
                      "valueString": "Condition"
                    }
                  ]
                }
              ],
              "dependent": [
                {
                  "name": "ExtractEncounter",
                  "variable": [
                    "src",
                    "encounter"
                  ]
                },
                {
                  "name": "ExtractReactionManifestationCondition",
                  "variable": [
                    "src",
                    "condition",
                    "bundle"
                  ]
                },
                {
                  "name": "ExtractAdverseEvent",
                  "variable": [
                    "src",
                    "encounter",
                    "condition",
                    "bundle"
                  ]
                },
                {
                  "name": "UpdatePatient",
                  "variable": [
                    "src",
                    "bundle"
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "name": "UpdatePatient",
      "typeMode": "none",
      "input": [
        {
          "name": "src",
          "type": "QuestionnaireResponse",
          "mode": "source"
        },
        {
          "name": "bundle",
          "type": "Bundle",
          "mode": "target"
        }
      ],
      "rule": [
        {
          "name": "r_dod_exists",
          "source": [
            {
              "context": "src",
              "element": "item",
              "variable": "dod",
              "condition": "((linkId = '670552cf-cd9e-4596-9d89-5d6e4872d523') and answer.value.exists())"
            }
          ],
          "rule": [
            {
              "name": "r_patient",
              "source": [
                {
                  "context": "src",
                  "element": "item",
                  "variable": "pidItem",
                  "condition": "((linkId = 'patient-id') and answer.value.exists())"
                }
              ],
              "rule": [
                {
                  "name": "r_patient",
                  "source": [
                    {
                      "context": "src"
                    }
                  ],
                  "target": [
                    {
                      "context": "bundle",
                      "contextType": "variable",
                      "element": "entry",
                      "variable": "entry"
                    },
                    {
                      "context": "entry",
                      "contextType": "variable",
                      "element": "resource",
                      "variable": "patient",
                      "transform": "create",
                      "parameter": [
                        {
                          "valueString": "Patient"
                        }
                      ]
                    }
                  ],
                  "rule": [
                    {
                      "name": "r_patient_id",
                      "source": [
                        {
                          "context": "src"
                        }
                      ],
                      "target": [
                        {
                          "context": "patient",
                          "contextType": "variable",
                          "element": "id",
                          "variable": "pid",
                          "transform": "create",
                          "parameter": [
                            {
                              "valueString": "id"
                            }
                          ]
                        }
                      ],
                      "rule": [
                        {
                          "name": "r_pid_value",
                          "source": [
                            {
                              "context": "src"
                            }
                          ],
                          "target": [
                            {
                              "context": "pid",
                              "contextType": "variable",
                              "element": "value",
                              "transform": "evaluate",
                              "parameter": [
                                {
                                  "valueId": "pidItem"
                                },
                                {
                                  "valueString": "$this.answer.value.trim()"
                                }
                              ]
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "name": "r_dod",
                      "source": [
                        {
                          "context": "src"
                        }
                      ],
                      "target": [
                        {
                          "variable": "dateOfDeath",
                          "transform": "evaluate",
                          "parameter": [
                            {
                              "valueId": "src"
                            },
                            {
                              "valueString": "$this.item.where(linkId = '670552cf-cd9e-4596-9d89-5d6e4872d523').answer.value"
                            }
                          ]
                        }
                      ],
                      "rule": [
                        {
                          "name": "r_deceased_dt",
                          "source": [
                            {
                              "context": "src"
                            }
                          ],
                          "target": [
                            {
                              "context": "patient",
                              "contextType": "variable",
                              "element": "deceased",
                              "variable": "dt",
                              "transform": "create",
                              "parameter": [
                                {
                                  "valueString": "dateTime"
                                }
                              ]
                            },
                            {
                              "context": "dt",
                              "contextType": "variable",
                              "element": "value",
                              "transform": "evaluate",
                              "parameter": [
                                {
                                  "valueId": "dateOfDeath"
                                },
                                {
                                  "valueString": "$this.value.substring(0, 10) + 'T00:00:00.00Z'"
                                }
                              ]
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "name": "r_patient_active",
                      "source": [
                        {
                          "context": "src"
                        }
                      ],
                      "target": [
                        {
                          "context": "patient",
                          "contextType": "variable",
                          "element": "active",
                          "transform": "copy",
                          "parameter": [
                            {
                              "valueBoolean": false
                            }
                          ]
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "name": "ExtractEncounter",
      "typeMode": "none",
      "input": [
        {
          "name": "src",
          "type": "QuestionnaireResponse",
          "mode": "source"
        },
        {
          "name": "encounter",
          "type": "Encounter",
          "mode": "target"
        }
      ],
      "rule": [
        {
          "name": "r_en_static",
          "source": [
            {
              "context": "src"
            }
          ],
          "target": [
            {
              "context": "encounter",
              "contextType": "variable",
              "element": "id",
              "transform": "uuid"
            },
            {
              "context": "encounter",
              "contextType": "variable",
              "element": "status",
              "transform": "copy",
              "parameter": [
                {
                  "valueString": "finished"
                }
              ]
            },
            {
              "context": "encounter",
              "contextType": "variable",
              "element": "class",
              "transform": "c",
              "parameter": [
                {
                  "valueString": "http://terminology.hl7.org/CodeSystem/v3-ActCode"
                },
                {
                  "valueString": "HH"
                },
                {
                  "valueString": "Home health"
                }
              ]
            }
          ]
        },
        {
          "name": "r_cc",
          "source": [
            {
              "context": "src"
            }
          ],
          "target": [
            {
              "context": "encounter",
              "contextType": "variable",
              "element": "type",
              "variable": "cc",
              "transform": "create",
              "parameter": [
                {
                  "valueString": "CodeableConcept"
                }
              ]
            }
          ],
          "rule": [
            {
              "name": "r_cc_display",
              "source": [
                {
                  "context": "src"
                }
              ],
              "target": [
                {
                  "context": "cc",
                  "contextType": "variable",
                  "element": "text",
                  "transform": "copy",
                  "parameter": [
                    {
                      "valueString": "Allergies and adverse reactions"
                    }
                  ]
                }
              ]
            },
            {
              "name": "r_c",
              "source": [
                {
                  "context": "src"
                }
              ],
              "target": [
                {
                  "context": "cc",
                  "contextType": "variable",
                  "element": "coding",
                  "variable": "c",
                  "transform": "create",
                  "parameter": [
                    {
                      "valueString": "Coding"
                    }
                  ]
                }
              ],
              "rule": [
                {
                  "name": "r_c_system",
                  "source": [
                    {
                      "context": "src"
                    }
                  ],
                  "target": [
                    {
                      "context": "c",
                      "contextType": "variable",
                      "element": "system",
                      "transform": "copy",
                      "parameter": [
                        {
                          "valueString": "http://smartregister.org"
                        }
                      ]
                    }
                  ]
                },
                {
                  "name": "r_c_code",
                  "source": [
                    {
                      "context": "src"
                    }
                  ],
                  "target": [
                    {
                      "context": "c",
                      "contextType": "variable",
                      "element": "code",
                      "transform": "copy",
                      "parameter": [
                        {
                          "valueString": "886921000000105"
                        }
                      ]
                    }
                  ]
                },
                {
                  "name": "r_c_display",
                  "source": [
                    {
                      "context": "src"
                    }
                  ],
                  "target": [
                    {
                      "context": "c",
                      "contextType": "variable",
                      "element": "display",
                      "transform": "copy",
                      "parameter": [
                        {
                          "valueString": "Allergies and adverse reactions"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "name": "r_cc",
          "source": [
            {
              "context": "src"
            }
          ],
          "target": [
            {
              "context": "encounter",
              "contextType": "variable",
              "element": "priority",
              "variable": "cc",
              "transform": "create",
              "parameter": [
                {
                  "valueString": "CodeableConcept"
                }
              ]
            }
          ],
          "rule": [
            {
              "name": "r_cc_display",
              "source": [
                {
                  "context": "src"
                }
              ],
              "target": [
                {
                  "context": "cc",
                  "contextType": "variable",
                  "element": "text",
                  "transform": "copy",
                  "parameter": [
                    {
                      "valueString": "Elective"
                    }
                  ]
                }
              ]
            },
            {
              "name": "r_c",
              "source": [
                {
                  "context": "src"
                }
              ],
              "target": [
                {
                  "context": "cc",
                  "contextType": "variable",
                  "element": "coding",
                  "variable": "c",
                  "transform": "create",
                  "parameter": [
                    {
                      "valueString": "Coding"
                    }
                  ]
                }
              ],
              "rule": [
                {
                  "name": "r_c_system",
                  "source": [
                    {
                      "context": "src"
                    }
                  ],
                  "target": [
                    {
                      "context": "c",
                      "contextType": "variable",
                      "element": "system",
                      "transform": "copy",
                      "parameter": [
                        {
                          "valueString": "http://terminology.hl7.org/ValueSet/v3-ActPriority"
                        }
                      ]
                    }
                  ]
                },
                {
                  "name": "r_c_code",
                  "source": [
                    {
                      "context": "src"
                    }
                  ],
                  "target": [
                    {
                      "context": "c",
                      "contextType": "variable",
                      "element": "code",
                      "transform": "copy",
                      "parameter": [
                        {
                          "valueString": "EL"
                        }
                      ]
                    }
                  ]
                },
                {
                  "name": "r_c_display",
                  "source": [
                    {
                      "context": "src"
                    }
                  ],
                  "target": [
                    {
                      "context": "c",
                      "contextType": "variable",
                      "element": "display",
                      "transform": "copy",
                      "parameter": [
                        {
                          "valueString": "Elective"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "name": "r_en_subject",
          "source": [
            {
              "context": "src",
              "element": "subject",
              "variable": "subject"
            }
          ],
          "target": [
            {
              "context": "encounter",
              "contextType": "variable",
              "element": "subject",
              "transform": "copy",
              "parameter": [
                {
                  "valueId": "subject"
                }
              ]
            }
          ]
        },
        {
          "name": "r_enc_part_component",
          "source": [
            {
              "context": "src"
            }
          ],
          "target": [
            {
              "context": "encounter",
              "contextType": "variable",
              "element": "participant",
              "variable": "encounterParticipant",
              "transform": "create",
              "parameter": [
                {
                  "valueString": "Encounter_Participant"
                }
              ]
            }
          ],
          "rule": [
            {
              "name": "r_enc_part_individual",
              "source": [
                {
                  "context": "src"
                }
              ],
              "target": [
                {
                  "context": "encounterParticipant",
                  "contextType": "variable",
                  "element": "individual",
                  "variable": "encOwner",
                  "transform": "create",
                  "parameter": [
                    {
                      "valueString": "Reference"
                    }
                  ]
                }
              ],
              "rule": [
                {
                  "name": "r_enc_part_reference",
                  "source": [
                    {
                      "context": "src"
                    }
                  ],
                  "target": [
                    {
                      "context": "encOwner",
                      "contextType": "variable",
                      "element": "reference",
                      "transform": "evaluate",
                      "parameter": [
                        {
                          "valueId": "src"
                        },
                        {
                          "valueString": "'Practitioner/' + $this.meta.tag.where($this.system = 'https://smartregister.org/practitioner-tag-id').code"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "name": "r_en_period",
          "source": [
            {
              "context": "src"
            }
          ],
          "target": [
            {
              "context": "encounter",
              "contextType": "variable",
              "element": "period",
              "variable": "encounterPeriod",
              "transform": "create",
              "parameter": [
                {
                  "valueString": "Period"
                }
              ]
            }
          ],
          "rule": [
            {
              "name": "r_en_period_start",
              "source": [
                {
                  "context": "src"
                }
              ],
              "target": [
                {
                  "context": "encounterPeriod",
                  "contextType": "variable",
                  "element": "start",
                  "transform": "evaluate",
                  "parameter": [
                    {
                      "valueId": "src"
                    },
                    {
                      "valueString": "now()"
                    }
                  ]
                }
              ]
            },
            {
              "name": "r_en_period_end",
              "source": [
                {
                  "context": "src"
                }
              ],
              "target": [
                {
                  "context": "encounterPeriod",
                  "contextType": "variable",
                  "element": "end",
                  "transform": "evaluate",
                  "parameter": [
                    {
                      "valueId": "src"
                    },
                    {
                      "valueString": "now()"
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "name": "ExtractReactionManifestationCondition",
      "typeMode": "none",
      "input": [
        {
          "name": "src",
          "type": "QuestionnaireResponse",
          "mode": "source"
        },
        {
          "name": "cnd",
          "type": "Condition",
          "mode": "target"
        },
        {
          "name": "bundle",
          "type": "Bundle",
          "mode": "target"
        }
      ],
      "rule": [
        {
          "name": "r_cnd_id",
          "source": [
            {
              "context": "src"
            }
          ],
          "target": [
            {
              "context": "cnd",
              "contextType": "variable",
              "element": "id",
              "transform": "uuid"
            }
          ]
        },
        {
          "name": "r_cnd_onset_date",
          "source": [
            {
              "context": "src",
              "element": "item",
              "variable": "startReactionDate",
              "condition": "(linkId = 'recorded-date')"
            }
          ],
          "rule": [
            {
              "name": "r_cnd_onset_date_val",
              "source": [
                {
                  "context": "src"
                }
              ],
              "target": [
                {
                  "context": "cnd",
                  "contextType": "variable",
                  "element": "onset",
                  "variable": "dt",
                  "transform": "create",
                  "parameter": [
                    {
                      "valueString": "dateTime"
                    }
                  ]
                },
                {
                  "context": "dt",
                  "contextType": "variable",
                  "element": "value",
                  "transform": "evaluate",
                  "parameter": [
                    {
                      "valueId": "startReactionDate"
                    },
                    {
                      "valueString": "$this.answer.value.toString()"
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "name": "r_cnd_clinical_st",
          "source": [
            {
              "context": "src"
            }
          ],
          "target": [
            {
              "context": "cnd",
              "contextType": "variable",
              "element": "clinicalStatus",
              "transform": "cc",
              "parameter": [
                {
                  "valueString": "http://terminology.hl7.org/CodeSystem/condition-clinical"
                },
                {
                  "valueString": "active"
                }
              ]
            }
          ]
        },
        {
          "name": "r_cnd_sub",
          "source": [
            {
              "context": "src",
              "element": "subject",
              "variable": "subject"
            }
          ],
          "target": [
            {
              "context": "cnd",
              "contextType": "variable",
              "element": "subject",
              "transform": "copy",
              "parameter": [
                {
                  "valueId": "subject"
                }
              ]
            }
          ]
        },
        {
          "name": "r_cnd_recorded",
          "source": [
            {
              "context": "src"
            }
          ],
          "target": [
            {
              "context": "cnd",
              "contextType": "variable",
              "element": "recordedDate",
              "transform": "evaluate",
              "parameter": [
                {
                  "valueId": "src"
                },
                {
                  "valueString": "now()"
                }
              ]
            }
          ]
        },
        {
          "name": "r_reaction_manifestation",
          "source": [
            {
              "context": "src",
              "element": "item",
              "variable": "reactionManifestation",
              "condition": "(linkId = 'a2f71c64-5ccc-4575-8638-d51aeefe6e6c')"
            }
          ],
          "rule": [
            {
              "name": "r_cnd_code",
              "source": [
                {
                  "context": "src"
                }
              ],
              "target": [
                {
                  "context": "cnd",
                  "contextType": "variable",
                  "element": "code",
                  "variable": "cc",
                  "transform": "create",
                  "parameter": [
                    {
                      "valueString": "CodeableConcept"
                    }
                  ]
                }
              ],
              "rule": [
                {
                  "name": "r_c",
                  "source": [
                    {
                      "context": "src"
                    }
                  ],
                  "target": [
                    {
                      "context": "cc",
                      "contextType": "variable",
                      "element": "coding",
                      "variable": "c",
                      "transform": "create",
                      "parameter": [
                        {
                          "valueString": "Coding"
                        }
                      ]
                    }
                  ],
                  "rule": [
                    {
                      "name": "r_c_system",
                      "source": [
                        {
                          "context": "src"
                        }
                      ],
                      "target": [
                        {
                          "context": "c",
                          "contextType": "variable",
                          "element": "system",
                          "transform": "copy",
                          "parameter": [
                            {
                              "valueString": "http://smartregister.org"
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "name": "r_c_code",
                      "source": [
                        {
                          "context": "src"
                        }
                      ],
                      "target": [
                        {
                          "context": "c",
                          "contextType": "variable",
                          "element": "code",
                          "transform": "evaluate",
                          "parameter": [
                            {
                              "valueId": "reactionManifestation"
                            },
                            {
                              "valueString": "$this.answer.value.code"
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "name": "r_c_display",
                      "source": [
                        {
                          "context": "src"
                        }
                      ],
                      "target": [
                        {
                          "context": "c",
                          "contextType": "variable",
                          "element": "display",
                          "transform": "evaluate",
                          "parameter": [
                            {
                              "valueId": "reactionManifestation"
                            },
                            {
                              "valueString": "$this.answer.value.display"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "name": "r_cnd_code_text",
                  "source": [
                    {
                      "context": "src"
                    }
                  ],
                  "target": [
                    {
                      "context": "cc",
                      "contextType": "variable",
                      "element": "text",
                      "transform": "evaluate",
                      "parameter": [
                        {
                          "valueId": "reactionManifestation"
                        },
                        {
                          "valueString": "$this.answer.value.display"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "name": "ExtractAdverseEvent",
      "typeMode": "none",
      "input": [
        {
          "name": "src",
          "type": "QuestionnaireResponse",
          "mode": "source"
        },
        {
          "name": "encounter",
          "type": "Encounter",
          "mode": "source"
        },
        {
          "name": "condition",
          "type": "Condition",
          "mode": "source"
        },
        {
          "name": "bundle",
          "type": "Bundle",
          "mode": "target"
        }
      ],
      "rule": [
        {
          "name": "r_extract_adverse_event",
          "source": [
            {
              "context": "src"
            }
          ],
          "target": [
            {
              "context": "bundle",
              "contextType": "variable",
              "element": "entry",
              "variable": "entry"
            },
            {
              "context": "entry",
              "contextType": "variable",
              "element": "resource",
              "variable": "adverseEvent",
              "transform": "create",
              "parameter": [
                {
                  "valueString": "AdverseEvent"
                }
              ]
            }
          ],
          "rule": [
            {
              "name": "r_ae_static",
              "source": [
                {
                  "context": "src"
                }
              ],
              "target": [
                {
                  "context": "adverseEvent",
                  "contextType": "variable",
                  "element": "id",
                  "transform": "uuid"
                },
                {
                  "context": "adverseEvent",
                  "contextType": "variable",
                  "element": "encounter",
                  "transform": "reference",
                  "parameter": [
                    {
                      "valueId": "encounter"
                    }
                  ]
                },
                {
                  "context": "adverseEvent",
                  "contextType": "variable",
                  "element": "resultingCondition",
                  "transform": "reference",
                  "parameter": [
                    {
                      "valueId": "condition"
                    }
                  ]
                }
              ]
            },
            {
              "name": "r_ae_recorded_date",
              "source": [
                {
                  "context": "src"
                }
              ],
              "target": [
                {
                  "variable": "recordedDate",
                  "transform": "evaluate",
                  "parameter": [
                    {
                      "valueId": "src"
                    },
                    {
                      "valueString": "$this.item.where(linkId = 'recorded-date').answer.value"
                    }
                  ]
                }
              ],
              "rule": [
                {
                  "name": "r_recorded_date",
                  "source": [
                    {
                      "context": "src"
                    }
                  ],
                  "target": [
                    {
                      "context": "adverseEvent",
                      "contextType": "variable",
                      "element": "recordedDate",
                      "variable": "date",
                      "transform": "create",
                      "parameter": [
                        {
                          "valueString": "dateTime"
                        }
                      ]
                    },
                    {
                      "context": "date",
                      "contextType": "variable",
                      "element": "value",
                      "transform": "evaluate",
                      "parameter": [
                        {
                          "valueId": "recordedDate"
                        },
                        {
                          "valueString": "$this.value.substring(0, 10) + 'T00:00:00.00Z'"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "name": "r_ae_se_child",
              "source": [
                {
                  "context": "src",
                  "element": "item",
                  "variable": "item",
                  "condition": "($this.linkId.where(contains('child-vaccines')).exists())"
                }
              ],
              "rule": [
                {
                  "name": "r_ae_suspect_entity_child",
                  "source": [
                    {
                      "context": "src"
                    }
                  ],
                  "target": [
                    {
                      "context": "adverseEvent",
                      "contextType": "variable",
                      "element": "suspectEntity",
                      "variable": "aeSuspectEntity",
                      "transform": "create",
                      "parameter": [
                        {
                          "valueString": "AdverseEvent_SuspectEntity"
                        }
                      ]
                    }
                  ],
                  "rule": [
                    {
                      "name": "r_ae_suspect_entity_child",
                      "source": [
                        {
                          "context": "src"
                        }
                      ],
                      "target": [
                        {
                          "context": "aeSuspectEntity",
                          "contextType": "variable",
                          "element": "instance",
                          "variable": "aeOwner",
                          "transform": "create",
                          "parameter": [
                            {
                              "valueString": "Reference"
                            }
                          ]
                        }
                      ],
                      "rule": [
                        {
                          "name": "r_ae_suspect_entity_instance_child",
                          "source": [
                            {
                              "context": "src"
                            }
                          ],
                          "target": [
                            {
                              "variable": "immunization",
                              "transform": "evaluate",
                              "parameter": [
                                {
                                  "valueId": "src"
                                },
                                {
                                  "valueString": "$this.item.where(linkId = 'child-vaccines').answer.value.reference"
                                }
                              ]
                            }
                          ],
                          "rule": [
                            {
                              "name": "r_ae_suspect_entity_instance_ref_child",
                              "source": [
                                {
                                  "context": "src"
                                }
                              ],
                              "target": [
                                {
                                  "context": "aeOwner",
                                  "contextType": "variable",
                                  "element": "reference",
                                  "transform": "copy",
                                  "parameter": [
                                    {
                                      "valueId": "immunization"
                                    }
                                  ]
                                }
                              ]
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "name": "r_ro",
                      "source": [
                        {
                          "context": "src",
                          "element": "item",
                          "variable": "reactionOutcomeItem",
                          "condition": "((linkId = '9bbf6a69-3c16-4052-82a5-8ca9f9102ef3') and answer.value.exists())"
                        }
                      ],
                      "rule": [
                        {
                          "name": "r_causality",
                          "source": [
                            {
                              "context": "src"
                            }
                          ],
                          "target": [
                            {
                              "context": "aeSuspectEntity",
                              "contextType": "variable",
                              "element": "causality",
                              "variable": "causality",
                              "transform": "create",
                              "parameter": [
                                {
                                  "valueString": "AdverseEvent_SuspectEntityCausality"
                                }
                              ]
                            }
                          ],
                          "rule": [
                            {
                              "name": "r_cc",
                              "source": [
                                {
                                  "context": "src"
                                }
                              ],
                              "target": [
                                {
                                  "context": "causality",
                                  "contextType": "variable",
                                  "element": "assessment",
                                  "variable": "cc",
                                  "transform": "create",
                                  "parameter": [
                                    {
                                      "valueString": "CodeableConcept"
                                    }
                                  ]
                                }
                              ],
                              "rule": [
                                {
                                  "name": "r_cc_display",
                                  "source": [
                                    {
                                      "context": "src"
                                    }
                                  ],
                                  "target": [
                                    {
                                      "context": "cc",
                                      "contextType": "variable",
                                      "element": "text",
                                      "transform": "evaluate",
                                      "parameter": [
                                        {
                                          "valueId": "reactionOutcomeItem"
                                        },
                                        {
                                          "valueString": "$this.answer.value.display"
                                        }
                                      ]
                                    }
                                  ]
                                },
                                {
                                  "name": "r_c",
                                  "source": [
                                    {
                                      "context": "src"
                                    }
                                  ],
                                  "target": [
                                    {
                                      "context": "cc",
                                      "contextType": "variable",
                                      "element": "coding",
                                      "variable": "c",
                                      "transform": "create",
                                      "parameter": [
                                        {
                                          "valueString": "Coding"
                                        }
                                      ]
                                    }
                                  ],
                                  "rule": [
                                    {
                                      "name": "r_c_system",
                                      "source": [
                                        {
                                          "context": "src"
                                        }
                                      ],
                                      "target": [
                                        {
                                          "context": "c",
                                          "contextType": "variable",
                                          "element": "system",
                                          "transform": "copy",
                                          "parameter": [
                                            {
                                              "valueString": "http://smartregister.org"
                                            }
                                          ]
                                        }
                                      ]
                                    },
                                    {
                                      "name": "r_c_code",
                                      "source": [
                                        {
                                          "context": "src"
                                        }
                                      ],
                                      "target": [
                                        {
                                          "context": "c",
                                          "contextType": "variable",
                                          "element": "code",
                                          "transform": "evaluate",
                                          "parameter": [
                                            {
                                              "valueId": "reactionOutcomeItem"
                                            },
                                            {
                                              "valueString": "$this.answer.value.code"
                                            }
                                          ]
                                        }
                                      ]
                                    },
                                    {
                                      "name": "r_c_display",
                                      "source": [
                                        {
                                          "context": "src"
                                        }
                                      ],
                                      "target": [
                                        {
                                          "context": "c",
                                          "contextType": "variable",
                                          "element": "display",
                                          "transform": "evaluate",
                                          "parameter": [
                                            {
                                              "valueId": "reactionOutcomeItem"
                                            },
                                            {
                                              "valueString": "$this.answer.value.display"
                                            }
                                          ]
                                        }
                                      ]
                                    }
                                  ]
                                }
                              ]
                            }
                          ]
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "name": "r_ae_subject",
              "source": [
                {
                  "context": "src",
                  "element": "subject",
                  "variable": "subject"
                }
              ],
              "target": [
                {
                  "context": "adverseEvent",
                  "contextType": "variable",
                  "element": "subject",
                  "transform": "copy",
                  "parameter": [
                    {
                      "valueId": "subject"
                    }
                  ]
                }
              ]
            },
            {
              "name": "r_tor",
              "source": [
                {
                  "context": "src",
                  "element": "item",
                  "variable": "item",
                  "condition": "((linkId = '287f1e51-937b-4a44-ab72-6b82a0a1475f') and answer.value.exists())"
                }
              ],
              "rule": [
                {
                  "name": "r_cc",
                  "source": [
                    {
                      "context": "src"
                    }
                  ],
                  "target": [
                    {
                      "context": "adverseEvent",
                      "contextType": "variable",
                      "element": "severity",
                      "variable": "cc",
                      "transform": "create",
                      "parameter": [
                        {
                          "valueString": "CodeableConcept"
                        }
                      ]
                    }
                  ],
                  "rule": [
                    {
                      "name": "r_cc_display",
                      "source": [
                        {
                          "context": "src"
                        }
                      ],
                      "target": [
                        {
                          "context": "cc",
                          "contextType": "variable",
                          "element": "text",
                          "transform": "evaluate",
                          "parameter": [
                            {
                              "valueId": "item"
                            },
                            {
                              "valueString": "$this.answer.value.display"
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "name": "r_c",
                      "source": [
                        {
                          "context": "src"
                        }
                      ],
                      "target": [
                        {
                          "context": "cc",
                          "contextType": "variable",
                          "element": "coding",
                          "variable": "c",
                          "transform": "create",
                          "parameter": [
                            {
                              "valueString": "Coding"
                            }
                          ]
                        }
                      ],
                      "rule": [
                        {
                          "name": "r_c_system",
                          "source": [
                            {
                              "context": "src"
                            }
                          ],
                          "target": [
                            {
                              "context": "c",
                              "contextType": "variable",
                              "element": "system",
                              "transform": "copy",
                              "parameter": [
                                {
                                  "valueString": "http://smartregister.org"
                                }
                              ]
                            }
                          ]
                        },
                        {
                          "name": "r_c_code",
                          "source": [
                            {
                              "context": "src"
                            }
                          ],
                          "target": [
                            {
                              "context": "c",
                              "contextType": "variable",
                              "element": "code",
                              "transform": "evaluate",
                              "parameter": [
                                {
                                  "valueId": "item"
                                },
                                {
                                  "valueString": "$this.answer.value.code"
                                }
                              ]
                            }
                          ]
                        },
                        {
                          "name": "r_c_display",
                          "source": [
                            {
                              "context": "src"
                            }
                          ],
                          "target": [
                            {
                              "context": "c",
                              "contextType": "variable",
                              "element": "display",
                              "transform": "evaluate",
                              "parameter": [
                                {
                                  "valueId": "item"
                                },
                                {
                                  "valueString": "$this.answer.value.display"
                                }
                              ]
                            }
                          ]
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    }
  ]
}