{
  "resourceType": "StructureMap",
  "id": "8aa91198-0b9c-4622-ba30-04d1f3775fd8",
  "meta": {
    "versionId": "8",
    "lastUpdated": "2024-09-06T11:33:11.904+00:00"
  },
  "url": "https://fhir.demo.smartregister.org/fhir/StructureMap/8aa91198-0b9c-4622-ba30-04d1f3775fd8",
  "name": "RecordChildImmunization",
  "structure": [
    {
      "url": "http://hl7.org/fhir/StructureDefinition/QuestionnaireResponse",
      "mode": "source"
    },
    {
      "url": "http://hl7.org/fhir/StructureDefinition/Bundle",
      "mode": "target"
    }
  ],
  "group": [
    {
      "name": "ProcessChildImmunization",
      "typeMode": "none",
      "input": [
        {
          "name": "src",
          "type": "QuestionnaireResponse",
          "mode": "source"
        },
        {
          "name": "bundle",
          "type": "Bundle",
          "mode": "target"
        }
      ],
      "rule": [
        {
          "name": "r_en",
          "source": [
            {
              "context": "src"
            }
          ],
          "target": [
            {
              "variable": "encounter",
              "transform": "create",
              "parameter": [
                {
                  "valueString": "Encounter"
                }
              ]
            }
          ],
          "rule": [
            {
              "name": "r_en_static",
              "source": [
                {
                  "context": "src"
                }
              ],
              "target": [
                {
                  "context": "encounter",
                  "contextType": "variable",
                  "element": "id",
                  "transform": "uuid"
                },
                {
                  "context": "encounter",
                  "contextType": "variable",
                  "element": "status",
                  "transform": "copy",
                  "parameter": [
                    {
                      "valueString": "finished"
                    }
                  ]
                },
                {
                  "context": "encounter",
                  "contextType": "variable",
                  "element": "type",
                  "transform": "cc",
                  "parameter": [
                    {
                      "valueString": "https://smartregister.org/"
                    },
                    {
                      "valueString": "immunization"
                    },
                    {
                      "valueString": "Immunization"
                    }
                  ]
                },
                {
                  "context": "encounter",
                  "contextType": "variable",
                  "element": "class",
                  "transform": "c",
                  "parameter": [
                    {
                      "valueString": "http://terminology.hl7.org/CodeSystem/v3-ActCode"
                    },
                    {
                      "valueString": "HH"
                    },
                    {
                      "valueString": "home"
                    }
                  ]
                },
                {
                  "context": "encounter",
                  "contextType": "variable",
                  "element": "priority",
                  "variable": "encounterPriority",
                  "transform": "cc",
                  "parameter": [
                    {
                      "valueString": "http://terminology.hl7.org/ValueSet/v3-ActPriority"
                    },
                    {
                      "valueString": "EL"
                    },
                    {
                      "valueString": "Elective"
                    }
                  ]
                },
                {
                  "context": "encounterPriority",
                  "contextType": "variable",
                  "element": "text",
                  "transform": "copy",
                  "parameter": [
                    {
                      "valueString": "Elective"
                    }
                  ]
                }
              ]
            },
            {
              "name": "r_en_subject",
              "source": [
                {
                  "context": "src"
                }
              ],
              "target": [
                {
                  "context": "encounter",
                  "contextType": "variable",
                  "element": "subject",
                  "transform": "evaluate",
                  "parameter": [
                    {
                      "valueId": "src"
                    },
                    {
                      "valueString": "$this.subject"
                    }
                  ]
                }
              ]
            },
            {
              "name": "r_en_period",
              "source": [
                {
                  "context": "src"
                }
              ],
              "target": [
                {
                  "context": "encounter",
                  "contextType": "variable",
                  "element": "period",
                  "variable": "period",
                  "transform": "create",
                  "parameter": [
                    {
                      "valueString": "Period"
                    }
                  ]
                }
              ],
              "rule": [
                {
                  "name": "r_en_period_start",
                  "source": [
                    {
                      "context": "src"
                    }
                  ],
                  "target": [
                    {
                      "context": "period",
                      "contextType": "variable",
                      "element": "start",
                      "transform": "evaluate",
                      "parameter": [
                        {
                          "valueId": "src"
                        },
                        {
                          "valueString": "now()"
                        }
                      ]
                    }
                  ]
                },
                {
                  "name": "r_en_period_end",
                  "source": [
                    {
                      "context": "src"
                    }
                  ],
                  "target": [
                    {
                      "context": "period",
                      "contextType": "variable",
                      "element": "end",
                      "transform": "evaluate",
                      "parameter": [
                        {
                          "valueId": "src"
                        },
                        {
                          "valueString": "now()"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "name": "r_en_reason_code",
              "source": [
                {
                  "context": "src"
                }
              ],
              "target": [
                {
                  "context": "encounter",
                  "contextType": "variable",
                  "element": "reasonCode",
                  "variable": "reason",
                  "transform": "create",
                  "parameter": [
                    {
                      "valueString": "CodeableConcept"
                    }
                  ]
                }
              ],
              "rule": [
                {
                  "name": "r_en_reason_code_coding",
                  "source": [
                    {
                      "context": "src"
                    }
                  ],
                  "target": [
                    {
                      "context": "reason",
                      "contextType": "variable",
                      "element": "coding",
                      "variable": "coding",
                      "transform": "create",
                      "parameter": [
                        {
                          "valueString": "Coding"
                        }
                      ]
                    }
                  ],
                  "rule": [
                    {
                      "name": "r_en_reason_code_coding",
                      "source": [
                        {
                          "context": "src"
                        }
                      ],
                      "target": [
                        {
                          "context": "coding",
                          "contextType": "variable",
                          "element": "system",
                          "transform": "copy",
                          "parameter": [
                            {
                              "valueString": "http://smartregister.org"
                            }
                          ]
                        },
                        {
                          "context": "coding",
                          "contextType": "variable",
                          "element": "display",
                          "transform": "copy",
                          "parameter": [
                            {
                              "valueString": "Immunization"
                            }
                          ]
                        },
                        {
                          "context": "coding",
                          "contextType": "variable",
                          "element": "code",
                          "transform": "evaluate",
                          "parameter": [
                            {
                              "valueId": "src"
                            },
                            {
                              "valueString": "$this.item.where(linkId = 'task-code').answer.value"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "name": "r_en_reason_code_text",
                  "source": [
                    {
                      "context": "src"
                    }
                  ],
                  "target": [
                    {
                      "context": "reason",
                      "contextType": "variable",
                      "element": "text",
                      "transform": "evaluate",
                      "parameter": [
                        {
                          "valueId": "src"
                        },
                        {
                          "valueString": "$this.item.where(linkId = 'task-name').answer.value"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "name": "r_en_participant",
              "source": [
                {
                  "context": "src"
                }
              ],
              "target": [
                {
                  "context": "encounter",
                  "contextType": "variable",
                  "element": "participant",
                  "variable": "partComp",
                  "transform": "create",
                  "parameter": [
                    {
                      "valueString": "Encounter_Participant"
                    }
                  ]
                }
              ],
              "rule": [
                {
                  "name": "r_en_participant_individual",
                  "source": [
                    {
                      "context": "src"
                    }
                  ],
                  "target": [
                    {
                      "context": "partComp",
                      "contextType": "variable",
                      "element": "individual",
                      "variable": "encOwner",
                      "transform": "create",
                      "parameter": [
                        {
                          "valueString": "Reference"
                        }
                      ]
                    }
                  ],
                  "rule": [
                    {
                      "name": "r_en_participant_reference",
                      "source": [
                        {
                          "context": "src"
                        }
                      ],
                      "target": [
                        {
                          "context": "encOwner",
                          "contextType": "variable",
                          "element": "reference",
                          "transform": "evaluate",
                          "parameter": [
                            {
                              "valueId": "src"
                            },
                            {
                              "valueString": "'Practitioner/' + $this.meta.tag.where($this.system = 'https://smartregister.org/practitioner-tag-id').code"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "name": "r_en_extract_encounter_location",
              "source": [
                {
                  "context": "src"
                }
              ],
              "dependent": [
                {
                  "name": "ExtractTaskStatus",
                  "variable": [
                    "src",
                    "bundle"
                  ]
                }
              ]
            },
            {
              "name": "r_en_extract_encounter_location",
              "source": [
                {
                  "context": "src"
                }
              ],
              "dependent": [
                {
                  "name": "ExtractEncounterLocation",
                  "variable": [
                    "src",
                    "encounter"
                  ]
                }
              ]
            },
            {
              "name": "r_en_extract_flag",
              "source": [
                {
                  "context": "src"
                }
              ],
              "dependent": [
                {
                  "name": "ExtractVaccineNotGivenFlag",
                  "variable": [
                    "src",
                    "bundle",
                    "encounter"
                  ]
                }
              ]
            },
            {
              "name": "r_en_bundle_entry",
              "source": [
                {
                  "context": "src"
                }
              ],
              "target": [
                {
                  "context": "bundle",
                  "contextType": "variable",
                  "element": "entry",
                  "variable": "entry"
                },
                {
                  "context": "entry",
                  "contextType": "variable",
                  "element": "resource",
                  "transform": "copy",
                  "parameter": [
                    {
                      "valueId": "encounter"
                    }
                  ]
                },
                {
                  "variable": "immunization",
                  "transform": "create",
                  "parameter": [
                    {
                      "valueString": "Immunization"
                    }
                  ]
                }
              ],
              "dependent": [
                {
                  "name": "ExtractImmunization",
                  "variable": [
                    "src",
                    "encounter",
                    "immunization",
                    "bundle"
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "name": "ExtractEncounterLocation",
      "typeMode": "none",
      "input": [
        {
          "name": "src",
          "type": "QuestionnaireResponse",
          "mode": "source"
        },
        {
          "name": "encounter",
          "type": "Encounter",
          "mode": "target"
        }
      ],
      "rule": [
        {
          "name": "r_en_location_static_check",
          "source": [
            {
              "context": "src",
              "element": "item",
              "variable": "item",
              "condition": "($this.linkId.where(contains('fd79b6b3-c269-4694-83fd-cd9e37170c26')).exists() and ($this.answer.value.code = 'static'))"
            }
          ],
          "rule": [
            {
              "name": "r_en_location_static_component",
              "source": [
                {
                  "context": "src"
                }
              ],
              "target": [
                {
                  "context": "encounter",
                  "contextType": "variable",
                  "element": "location",
                  "variable": "loc",
                  "transform": "create",
                  "parameter": [
                    {
                      "valueString": "Encounter_Location"
                    }
                  ]
                }
              ],
              "rule": [
                {
                  "name": "r_en_location_static",
                  "source": [
                    {
                      "context": "src"
                    }
                  ],
                  "target": [
                    {
                      "context": "loc",
                      "contextType": "variable",
                      "element": "location",
                      "variable": "ref",
                      "transform": "create",
                      "parameter": [
                        {
                          "valueString": "Reference"
                        }
                      ]
                    }
                  ],
                  "rule": [
                    {
                      "name": "r_en_location_static_reference",
                      "source": [
                        {
                          "context": "src"
                        }
                      ],
                      "target": [
                        {
                          "context": "ref",
                          "contextType": "variable",
                          "element": "reference",
                          "transform": "copy",
                          "parameter": [
                            {
                              "valueString": "#001"
                            }
                          ]
                        },
                        {
                          "context": "ref",
                          "contextType": "variable",
                          "element": "display",
                          "transform": "copy",
                          "parameter": [
                            {
                              "valueString": "Static"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "name": "r_en_location_static_status",
                  "source": [
                    {
                      "context": "src"
                    }
                  ],
                  "target": [
                    {
                      "context": "loc",
                      "contextType": "variable",
                      "element": "status",
                      "transform": "copy",
                      "parameter": [
                        {
                          "valueString": "completed"
                        }
                      ]
                    },
                    {
                      "context": "loc",
                      "contextType": "variable",
                      "element": "period",
                      "transform": "evaluate",
                      "parameter": [
                        {
                          "valueId": "encounter"
                        },
                        {
                          "valueString": "$this.period"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "name": "r_en_location_outreach_check",
          "source": [
            {
              "context": "src",
              "element": "item",
              "variable": "item",
              "condition": "($this.linkId.where(contains('fd79b6b3-c269-4694-83fd-cd9e37170c26')).exists() and ($this.answer.value.code = 'outreach'))"
            }
          ],
          "rule": [
            {
              "name": "r_en_location_outreach_component",
              "source": [
                {
                  "context": "src"
                }
              ],
              "target": [
                {
                  "context": "encounter",
                  "contextType": "variable",
                  "element": "location",
                  "variable": "loc",
                  "transform": "create",
                  "parameter": [
                    {
                      "valueString": "Encounter_Location"
                    }
                  ]
                }
              ],
              "rule": [
                {
                  "name": "r_en_location_outreach",
                  "source": [
                    {
                      "context": "src"
                    }
                  ],
                  "target": [
                    {
                      "context": "loc",
                      "contextType": "variable",
                      "element": "location",
                      "variable": "ref",
                      "transform": "create",
                      "parameter": [
                        {
                          "valueString": "Reference"
                        }
                      ]
                    }
                  ],
                  "rule": [
                    {
                      "name": "r_en_location_outreach_reference",
                      "source": [
                        {
                          "context": "src"
                        }
                      ],
                      "target": [
                        {
                          "context": "ref",
                          "contextType": "variable",
                          "element": "reference",
                          "transform": "copy",
                          "parameter": [
                            {
                              "valueString": "#002"
                            }
                          ]
                        },
                        {
                          "context": "ref",
                          "contextType": "variable",
                          "element": "display",
                          "transform": "copy",
                          "parameter": [
                            {
                              "valueString": "Outreach"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "name": "r_en_location_outreach_status",
                  "source": [
                    {
                      "context": "src"
                    }
                  ],
                  "target": [
                    {
                      "context": "loc",
                      "contextType": "variable",
                      "element": "status",
                      "transform": "copy",
                      "parameter": [
                        {
                          "valueString": "completed"
                        }
                      ]
                    },
                    {
                      "context": "loc",
                      "contextType": "variable",
                      "element": "period",
                      "transform": "evaluate",
                      "parameter": [
                        {
                          "valueId": "encounter"
                        },
                        {
                          "valueString": "$this.period"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "name": "r_en_loc_village",
          "source": [
            {
              "context": "src",
              "element": "item",
              "variable": "item",
              "condition": "((linkId = 'b00bda77-6df2-4660-8134-c424fb1dbf4f') and answer.value.exists())"
            }
          ],
          "rule": [
            {
              "name": "r_en_loc_village_comp",
              "source": [
                {
                  "context": "src"
                }
              ],
              "target": [
                {
                  "context": "encounter",
                  "contextType": "variable",
                  "element": "location",
                  "variable": "loc",
                  "transform": "create",
                  "parameter": [
                    {
                      "valueString": "Encounter_Location"
                    }
                  ]
                }
              ],
              "rule": [
                {
                  "name": "r_en_loc_village_ref",
                  "source": [
                    {
                      "context": "src"
                    }
                  ],
                  "target": [
                    {
                      "context": "loc",
                      "contextType": "variable",
                      "element": "location",
                      "transform": "evaluate",
                      "parameter": [
                        {
                          "valueId": "item"
                        },
                        {
                          "valueString": "$this.answer.value"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "name": "ExtractImmunization",
      "typeMode": "none",
      "input": [
        {
          "name": "src",
          "type": "QuestionnaireResponse",
          "mode": "source"
        },
        {
          "name": "encounter",
          "type": "Encounter",
          "mode": "source"
        },
        {
          "name": "immunization",
          "type": "Immunization",
          "mode": "target"
        },
        {
          "name": "bundle",
          "type": "Bundle",
          "mode": "target"
        }
      ],
      "rule": [
        {
          "name": "r_imm",
          "source": [
            {
              "context": "src",
              "element": "item",
              "condition": "((linkId = '6c1c6d0e-7dd5-4665-9df1-343a9dc5e17f') and (answer.value.code = 'yes'))"
            }
          ],
          "rule": [
            {
              "name": "r_imm_static",
              "source": [
                {
                  "context": "src"
                }
              ],
              "target": [
                {
                  "context": "immunization",
                  "contextType": "variable",
                  "element": "id",
                  "transform": "uuid"
                },
                {
                  "context": "immunization",
                  "contextType": "variable",
                  "element": "recorded",
                  "transform": "evaluate",
                  "parameter": [
                    {
                      "valueId": "src"
                    },
                    {
                      "valueString": "now()"
                    }
                  ]
                },
                {
                  "context": "immunization",
                  "contextType": "variable",
                  "element": "status",
                  "transform": "copy",
                  "parameter": [
                    {
                      "valueString": "completed"
                    }
                  ]
                },
                {
                  "variable": "vaccineDate",
                  "transform": "create",
                  "parameter": [
                    {
                      "valueString": "dateTime"
                    }
                  ]
                },
                {
                  "context": "vaccineDate",
                  "contextType": "variable",
                  "element": "value",
                  "transform": "evaluate",
                  "parameter": [
                    {
                      "valueId": "src"
                    },
                    {
                      "valueString": "$this.descendants().where(linkId = '1e1f0f3b-58de-41b4-8db0-6c4b033cce57').answer.value.toString()"
                    }
                  ]
                },
                {
                  "context": "immunization",
                  "contextType": "variable",
                  "element": "occurrence",
                  "transform": "copy",
                  "parameter": [
                    {
                      "valueId": "vaccineDate"
                    }
                  ]
                },
                {
                  "context": "immunization",
                  "contextType": "variable",
                  "element": "lotNumber",
                  "transform": "evaluate",
                  "parameter": [
                    {
                      "valueId": "src"
                    },
                    {
                      "valueString": "$this.descendants().where(linkId = 'batch_number').answer.value"
                    }
                  ]
                },
                {
                  "context": "immunization",
                  "contextType": "variable",
                  "element": "patient",
                  "transform": "evaluate",
                  "parameter": [
                    {
                      "valueId": "src"
                    },
                    {
                      "valueString": "subject"
                    }
                  ]
                },
                {
                  "context": "immunization",
                  "contextType": "variable",
                  "element": "encounter",
                  "transform": "reference",
                  "parameter": [
                    {
                      "valueId": "encounter"
                    }
                  ]
                }
              ]
            },
            {
              "name": "r_imm_vaccineCode",
              "source": [
                {
                  "context": "src"
                }
              ],
              "target": [
                {
                  "context": "immunization",
                  "contextType": "variable",
                  "element": "vaccineCode",
                  "variable": "vaccineCode",
                  "transform": "create",
                  "parameter": [
                    {
                      "valueString": "CodeableConcept"
                    }
                  ]
                }
              ],
              "rule": [
                {
                  "name": "r_imm_vaccineCode_imm",
                  "source": [
                    {
                      "context": "src"
                    }
                  ],
                  "target": [
                    {
                      "variable": "immunizationCode",
                      "transform": "evaluate",
                      "parameter": [
                        {
                          "valueId": "src"
                        },
                        {
                          "valueString": "$this.item.where(linkId = 'task-code').answer.value.toString()"
                        }
                      ]
                    }
                  ],
                  "rule": [
                    {
                      "name": "r_imm_vaccineCode_imm_coding",
                      "source": [
                        {
                          "context": "src"
                        }
                      ],
                      "target": [
                        {
                          "context": "vaccineCode",
                          "contextType": "variable",
                          "element": "coding",
                          "variable": "vaccineCodeCoding",
                          "transform": "c",
                          "parameter": [
                            {
                              "valueString": "http://smartregister.org"
                            },
                            {
                              "valueId": "immunizationCode"
                            }
                          ]
                        }
                      ],
                      "rule": [
                        {
                          "name": "r_imm_vaccineCode_imm_coding_code",
                          "source": [
                            {
                              "context": "src"
                            }
                          ],
                          "target": [
                            {
                              "variable": "immunizationName",
                              "transform": "evaluate",
                              "parameter": [
                                {
                                  "valueId": "src"
                                },
                                {
                                  "valueString": "$this.item.where(linkId = 'task-name').answer.value.toString()"
                                }
                              ]
                            }
                          ],
                          "rule": [
                            {
                              "name": "r_imm_vaccineCode_coding_display",
                              "source": [
                                {
                                  "context": "src"
                                }
                              ],
                              "target": [
                                {
                                  "context": "vaccineCodeCoding",
                                  "contextType": "variable",
                                  "element": "display",
                                  "transform": "evaluate",
                                  "parameter": [
                                    {
                                      "valueId": "src"
                                    },
                                    {
                                      "valueString": "$this.item.where(linkId = 'task-name').answer.value.toString()"
                                    }
                                  ]
                                }
                              ]
                            },
                            {
                              "name": "r_imm_vaccineCode_text",
                              "source": [
                                {
                                  "context": "src"
                                }
                              ],
                              "target": [
                                {
                                  "context": "vaccineCode",
                                  "contextType": "variable",
                                  "element": "text",
                                  "transform": "evaluate",
                                  "parameter": [
                                    {
                                      "valueId": "src"
                                    },
                                    {
                                      "valueString": "$this.item.where(linkId = 'task-description').answer.value.toString()"
                                    }
                                  ]
                                }
                              ]
                            }
                          ]
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "name": "r_imm_protocolapplied_taskname",
              "source": [
                {
                  "context": "src",
                  "element": "item",
                  "variable": "taskName",
                  "condition": "(linkId = 'task-name')"
                }
              ],
              "rule": [
                {
                  "name": "r_imm_protocolapplied",
                  "source": [
                    {
                      "context": "src"
                    }
                  ],
                  "target": [
                    {
                      "context": "immunization",
                      "contextType": "variable",
                      "element": "protocolApplied",
                      "variable": "protocolApplied",
                      "transform": "create",
                      "parameter": [
                        {
                          "valueString": "Immunization_AppliedProtocol"
                        }
                      ]
                    }
                  ],
                  "rule": [
                    {
                      "name": "r_imm_protocolapplied_dose_taskdesc",
                      "source": [
                        {
                          "context": "src"
                        }
                      ],
                      "target": [
                        {
                          "variable": "taskDesc",
                          "transform": "evaluate",
                          "parameter": [
                            {
                              "valueId": "src"
                            },
                            {
                              "valueString": "$this.item.where(linkId = 'task-description').answer.value.toString().lower()"
                            }
                          ]
                        }
                      ],
                      "rule": [
                        {
                          "name": "r_imm_protocolapplied_dose_group",
                          "source": [
                            {
                              "context": "src",
                              "element": "item",
                              "variable": "vaccineItems",
                              "condition": "(linkId = 'vaccine-dose-numbers')"
                            }
                          ],
                          "rule": [
                            {
                              "name": "r_imm_protocolapplied_dosenumber",
                              "source": [
                                {
                                  "context": "vaccineItems",
                                  "element": "item",
                                  "variable": "vaccine"
                                }
                              ],
                              "target": [
                                {
                                  "context": "protocolApplied",
                                  "contextType": "variable",
                                  "element": "doseNumber",
                                  "transform": "evaluate",
                                  "parameter": [
                                    {
                                      "valueId": "vaccine"
                                    },
                                    {
                                      "valueString": "src.item.descendants().where(linkId = taskDesc).answer.value"
                                    }
                                  ]
                                }
                              ]
                            }
                          ]
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "name": "r_imm_extract_output",
              "source": [
                {
                  "context": "src"
                }
              ],
              "dependent": [
                {
                  "name": "extractTaskOutput",
                  "variable": [
                    "src",
                    "encounter",
                    "immunization",
                    "bundle"
                  ]
                }
              ]
            },
            {
              "name": "r_bundle_entry_imm",
              "source": [
                {
                  "context": "src"
                }
              ],
              "target": [
                {
                  "context": "bundle",
                  "contextType": "variable",
                  "element": "entry",
                  "variable": "entry"
                },
                {
                  "context": "entry",
                  "contextType": "variable",
                  "element": "resource",
                  "transform": "copy",
                  "parameter": [
                    {
                      "valueId": "immunization"
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "name": "extractTaskOutput",
      "typeMode": "none",
      "input": [
        {
          "name": "src",
          "type": "QuestionnaireResponse",
          "mode": "source"
        },
        {
          "name": "encounter",
          "type": "Encounter",
          "mode": "source"
        },
        {
          "name": "immunization",
          "type": "Immunization",
          "mode": "source"
        },
        {
          "name": "bundle",
          "type": "Bundle",
          "mode": "target"
        }
      ],
      "rule": [
        {
          "name": "r_task",
          "source": [
            {
              "context": "src"
            }
          ],
          "target": [
            {
              "context": "bundle",
              "contextType": "variable",
              "element": "entry",
              "variable": "entry"
            },
            {
              "context": "entry",
              "contextType": "variable",
              "element": "resource",
              "variable": "task",
              "transform": "create",
              "parameter": [
                {
                  "valueString": "Task"
                }
              ]
            }
          ],
          "rule": [
            {
              "name": "r_task_get_existing",
              "source": [
                {
                  "context": "src"
                }
              ],
              "target": [
                {
                  "context": "task",
                  "contextType": "variable",
                  "element": "id",
                  "variable": "id",
                  "transform": "create",
                  "parameter": [
                    {
                      "valueString": "id"
                    }
                  ]
                }
              ],
              "rule": [
                {
                  "name": "r_task_id",
                  "source": [
                    {
                      "context": "src"
                    }
                  ],
                  "target": [
                    {
                      "context": "id",
                      "contextType": "variable",
                      "element": "value",
                      "transform": "evaluate",
                      "parameter": [
                        {
                          "valueId": "src"
                        },
                        {
                          "valueString": "$this.item.where(linkId = 'logical-task-id').answer.value.toString()"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "name": "r_task_status",
              "source": [
                {
                  "context": "src"
                }
              ],
              "target": [
                {
                  "context": "task",
                  "contextType": "variable",
                  "element": "status",
                  "transform": "copy",
                  "parameter": [
                    {
                      "valueString": "completed"
                    }
                  ]
                }
              ]
            },
            {
              "name": "r_task_output_2",
              "source": [
                {
                  "context": "src"
                }
              ],
              "target": [
                {
                  "context": "task",
                  "contextType": "variable",
                  "element": "output",
                  "variable": "outputTask",
                  "transform": "create",
                  "parameter": [
                    {
                      "valueString": "Task_Output"
                    }
                  ]
                }
              ],
              "rule": [
                {
                  "name": "r_task_output_2_type",
                  "source": [
                    {
                      "context": "src"
                    }
                  ],
                  "target": [
                    {
                      "context": "outputTask",
                      "contextType": "variable",
                      "element": "type",
                      "variable": "concept",
                      "transform": "create",
                      "parameter": [
                        {
                          "valueString": "CodeableConcept"
                        }
                      ]
                    }
                  ],
                  "rule": [
                    {
                      "name": "r_task_output_2_type_coding",
                      "source": [
                        {
                          "context": "src"
                        }
                      ],
                      "target": [
                        {
                          "context": "concept",
                          "contextType": "variable",
                          "element": "coding",
                          "variable": "coding",
                          "transform": "c",
                          "parameter": [
                            {
                              "valueString": "http://smartregister.org"
                            },
                            {
                              "valueString": "41000179103"
                            }
                          ]
                        }
                      ],
                      "rule": [
                        {
                          "name": "r_task_output_2_type_coding_display",
                          "source": [
                            {
                              "context": "src"
                            }
                          ],
                          "target": [
                            {
                              "context": "coding",
                              "contextType": "variable",
                              "element": "display",
                              "transform": "copy",
                              "parameter": [
                                {
                                  "valueString": "Immunization record (record artifact)"
                                }
                              ]
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "name": "r_task_output_2_type_value",
                  "source": [
                    {
                      "context": "src"
                    }
                  ],
                  "target": [
                    {
                      "context": "outputTask",
                      "contextType": "variable",
                      "element": "value",
                      "transform": "reference",
                      "parameter": [
                        {
                          "valueId": "encounter"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "name": "r_task_output_3",
              "source": [
                {
                  "context": "src"
                }
              ],
              "target": [
                {
                  "context": "task",
                  "contextType": "variable",
                  "element": "output",
                  "variable": "outputTask",
                  "transform": "create",
                  "parameter": [
                    {
                      "valueString": "Task_Output"
                    }
                  ]
                }
              ],
              "rule": [
                {
                  "name": "r_task_output_3_type",
                  "source": [
                    {
                      "context": "src"
                    }
                  ],
                  "target": [
                    {
                      "context": "outputTask",
                      "contextType": "variable",
                      "element": "type",
                      "variable": "concept",
                      "transform": "create",
                      "parameter": [
                        {
                          "valueString": "CodeableConcept"
                        }
                      ]
                    }
                  ],
                  "rule": [
                    {
                      "name": "r_task_output_3_type_coding",
                      "source": [
                        {
                          "context": "src"
                        }
                      ],
                      "target": [
                        {
                          "context": "concept",
                          "contextType": "variable",
                          "element": "coding",
                          "variable": "coding",
                          "transform": "c",
                          "parameter": [
                            {
                              "valueString": "http://smartregister.org"
                            },
                            {
                              "valueString": "41000179103"
                            }
                          ]
                        }
                      ],
                      "rule": [
                        {
                          "name": "r_task_output_3_type_coding_display",
                          "source": [
                            {
                              "context": "src"
                            }
                          ],
                          "target": [
                            {
                              "context": "coding",
                              "contextType": "variable",
                              "element": "display",
                              "transform": "copy",
                              "parameter": [
                                {
                                  "valueString": "Immunization record (record artifact)"
                                }
                              ]
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "name": "r_task_output_3_type_value",
                  "source": [
                    {
                      "context": "src"
                    }
                  ],
                  "target": [
                    {
                      "context": "outputTask",
                      "contextType": "variable",
                      "element": "value",
                      "transform": "reference",
                      "parameter": [
                        {
                          "valueId": "immunization"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "name": "r_task_output_4",
              "source": [
                {
                  "context": "src"
                }
              ],
              "target": [
                {
                  "context": "task",
                  "contextType": "variable",
                  "element": "output",
                  "variable": "outputTask",
                  "transform": "create",
                  "parameter": [
                    {
                      "valueString": "Task_Output"
                    }
                  ]
                }
              ],
              "rule": [
                {
                  "name": "r_task_output_4_type",
                  "source": [
                    {
                      "context": "src"
                    }
                  ],
                  "target": [
                    {
                      "context": "outputTask",
                      "contextType": "variable",
                      "element": "type",
                      "variable": "concept",
                      "transform": "create",
                      "parameter": [
                        {
                          "valueString": "CodeableConcept"
                        }
                      ]
                    }
                  ],
                  "rule": [
                    {
                      "name": "r_task_output_4_type_coding",
                      "source": [
                        {
                          "context": "src"
                        }
                      ],
                      "target": [
                        {
                          "context": "concept",
                          "contextType": "variable",
                          "element": "coding",
                          "variable": "coding",
                          "transform": "c",
                          "parameter": [
                            {
                              "valueString": "http://smartregister.org"
                            },
                            {
                              "valueString": "35123003"
                            }
                          ]
                        }
                      ],
                      "rule": [
                        {
                          "name": "r_task_output_4_type_coding_display",
                          "source": [
                            {
                              "context": "src"
                            }
                          ],
                          "target": [
                            {
                              "context": "coding",
                              "contextType": "variable",
                              "element": "display",
                              "transform": "copy",
                              "parameter": [
                                {
                                  "valueString": "Immunization record (record artifact)"
                                }
                              ]
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "name": "r_task_output_4_vaccine_date",
                  "source": [
                    {
                      "context": "src"
                    }
                  ],
                  "target": [
                    {
                      "variable": "vaccineDate",
                      "transform": "create",
                      "parameter": [
                        {
                          "valueString": "dateTime"
                        }
                      ]
                    },
                    {
                      "context": "vaccineDate",
                      "contextType": "variable",
                      "element": "value",
                      "transform": "evaluate",
                      "parameter": [
                        {
                          "valueId": "src"
                        },
                        {
                          "valueString": "$this.descendants().where(linkId = '1e1f0f3b-58de-41b4-8db0-6c4b033cce57').answer.value.toString()"
                        }
                      ]
                    },
                    {
                      "context": "outputTask",
                      "contextType": "variable",
                      "element": "value",
                      "transform": "copy",
                      "parameter": [
                        {
                          "valueId": "vaccineDate"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "name": "ExtractTaskStatus",
      "typeMode": "none",
      "input": [
        {
          "name": "src",
          "type": "QuestionnaireResponse",
          "mode": "source"
        },
        {
          "name": "bundle",
          "type": "Bundle",
          "mode": "target"
        }
      ],
      "rule": [
        {
          "name": "r_task_vaccine_not_given",
          "source": [
            {
              "context": "src",
              "element": "item",
              "condition": "((linkId = '6c1c6d0e-7dd5-4665-9df1-343a9dc5e17f') and answer.value.exists() and (answer.value.code = 'no'))"
            }
          ],
          "rule": [
            {
              "name": "r_task",
              "source": [
                {
                  "context": "src"
                }
              ],
              "target": [
                {
                  "context": "bundle",
                  "contextType": "variable",
                  "element": "entry",
                  "variable": "entry"
                },
                {
                  "context": "entry",
                  "contextType": "variable",
                  "element": "resource",
                  "variable": "task",
                  "transform": "create",
                  "parameter": [
                    {
                      "valueString": "Task"
                    }
                  ]
                }
              ],
              "rule": [
                {
                  "name": "r_task_status_id",
                  "source": [
                    {
                      "context": "src"
                    }
                  ],
                  "target": [
                    {
                      "context": "task",
                      "contextType": "variable",
                      "element": "id",
                      "variable": "id",
                      "transform": "create",
                      "parameter": [
                        {
                          "valueString": "id"
                        }
                      ]
                    }
                  ],
                  "rule": [
                    {
                      "name": "r_task_status_get_existing",
                      "source": [
                        {
                          "context": "src"
                        }
                      ],
                      "target": [
                        {
                          "context": "id",
                          "contextType": "variable",
                          "element": "value",
                          "transform": "evaluate",
                          "parameter": [
                            {
                              "valueId": "src"
                            },
                            {
                              "valueString": "$this.item.where(linkId = 'logical-task-id').answer.value.toString()"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "name": "r_task_status",
                  "source": [
                    {
                      "context": "src"
                    }
                  ],
                  "target": [
                    {
                      "context": "task",
                      "contextType": "variable",
                      "element": "status",
                      "transform": "copy",
                      "parameter": [
                        {
                          "valueString": "failed"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "name": "ExtractVaccineNotGivenFlag",
      "typeMode": "none",
      "input": [
        {
          "name": "src",
          "type": "QuestionnaireResponse",
          "mode": "source"
        },
        {
          "name": "bundle",
          "type": "Bundle",
          "mode": "target"
        },
        {
          "name": "encounter",
          "type": "Encounter",
          "mode": "target"
        }
      ],
      "rule": [
        {
          "name": "r_flag_vaccine_not_given",
          "source": [
            {
              "context": "src",
              "element": "item",
              "condition": "((linkId = '6c1c6d0e-7dd5-4665-9df1-343a9dc5e17f') and answer.value.exists() and (answer.value.code = 'no'))"
            }
          ],
          "rule": [
            {
              "name": "r_flag",
              "source": [
                {
                  "context": "src"
                }
              ],
              "target": [
                {
                  "context": "bundle",
                  "contextType": "variable",
                  "element": "entry",
                  "variable": "entry"
                },
                {
                  "context": "entry",
                  "contextType": "variable",
                  "element": "resource",
                  "variable": "flag",
                  "transform": "create",
                  "parameter": [
                    {
                      "valueString": "Flag"
                    }
                  ]
                }
              ],
              "rule": [
                {
                  "name": "r_flag_static",
                  "source": [
                    {
                      "context": "src"
                    }
                  ],
                  "target": [
                    {
                      "context": "flag",
                      "contextType": "variable",
                      "element": "id",
                      "transform": "uuid"
                    },
                    {
                      "context": "flag",
                      "contextType": "variable",
                      "element": "subject",
                      "transform": "evaluate",
                      "parameter": [
                        {
                          "valueId": "src"
                        },
                        {
                          "valueString": "$this.subject"
                        }
                      ]
                    }
                  ]
                },
                {
                  "name": "r_flag_code",
                  "source": [
                    {
                      "context": "src"
                    }
                  ],
                  "target": [
                    {
                      "context": "flag",
                      "contextType": "variable",
                      "element": "code",
                      "variable": "concept",
                      "transform": "create",
                      "parameter": [
                        {
                          "valueString": "CodeableConcept"
                        }
                      ]
                    }
                  ],
                  "rule": [
                    {
                      "name": "r_flag_code_coding",
                      "source": [
                        {
                          "context": "src"
                        }
                      ],
                      "target": [
                        {
                          "context": "concept",
                          "contextType": "variable",
                          "element": "coding",
                          "variable": "coding",
                          "transform": "create",
                          "parameter": [
                            {
                              "valueString": "Coding"
                            }
                          ]
                        }
                      ],
                      "rule": [
                        {
                          "name": "r_flag_code_coding_system",
                          "source": [
                            {
                              "context": "src"
                            }
                          ],
                          "target": [
                            {
                              "context": "coding",
                              "contextType": "variable",
                              "element": "system",
                              "transform": "copy",
                              "parameter": [
                                {
                                  "valueString": "https://smartregister.org/"
                                }
                              ]
                            }
                          ]
                        },
                        {
                          "name": "r_flag_code_coding_code",
                          "source": [
                            {
                              "context": "src"
                            }
                          ],
                          "target": [
                            {
                              "context": "coding",
                              "contextType": "variable",
                              "element": "code",
                              "transform": "evaluate",
                              "parameter": [
                                {
                                  "valueId": "src"
                                },
                                {
                                  "valueString": "'Task/' + $this.item.where(linkId = 'logical-task-id').answer.value"
                                }
                              ]
                            }
                          ]
                        },
                        {
                          "name": "r_flag_code_coding_display",
                          "source": [
                            {
                              "context": "src"
                            }
                          ],
                          "target": [
                            {
                              "context": "coding",
                              "contextType": "variable",
                              "element": "display",
                              "transform": "evaluate",
                              "parameter": [
                                {
                                  "valueId": "src"
                                },
                                {
                                  "valueString": "'Vaccine_not_given_' + $this.item.where(linkId = '694be520-22b8-4c6c-8792-7e326294059c').answer.value.code"
                                }
                              ]
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "name": "r_flag_code_text",
                      "source": [
                        {
                          "context": "src"
                        }
                      ],
                      "target": [
                        {
                          "context": "concept",
                          "contextType": "variable",
                          "element": "text",
                          "transform": "copy",
                          "parameter": [
                            {
                              "valueString": "Vaccine Not Administered"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "name": "r_flag_period",
                  "source": [
                    {
                      "context": "src"
                    }
                  ],
                  "target": [
                    {
                      "context": "flag",
                      "contextType": "variable",
                      "element": "period",
                      "variable": "period",
                      "transform": "create",
                      "parameter": [
                        {
                          "valueString": "Period"
                        }
                      ]
                    }
                  ],
                  "rule": [
                    {
                      "name": "r_flag_period_start",
                      "source": [
                        {
                          "context": "src"
                        }
                      ],
                      "target": [
                        {
                          "context": "period",
                          "contextType": "variable",
                          "element": "start",
                          "transform": "evaluate",
                          "parameter": [
                            {
                              "valueId": "src"
                            },
                            {
                              "valueString": "now()"
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "name": "r_flag_period_end",
                      "source": [
                        {
                          "context": "src"
                        }
                      ],
                      "target": [
                        {
                          "context": "period",
                          "contextType": "variable",
                          "element": "end",
                          "transform": "evaluate",
                          "parameter": [
                            {
                              "valueId": "src"
                            },
                            {
                              "valueString": "now()"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "name": "r_flag_encounter",
                  "source": [
                    {
                      "context": "src"
                    }
                  ],
                  "target": [
                    {
                      "context": "flag",
                      "contextType": "variable",
                      "element": "encounter",
                      "transform": "reference",
                      "parameter": [
                        {
                          "valueId": "encounter"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    }
  ]
}